#!/bin/bash
#
#This is the HPCNow! Remote Support Request script which allows to create a
# temporary SSH tunnel to allow HPCNow staff to get access to a remote cluster.
#
# Copyright (C) 2019 HPCNow!
#
# This program is distributed under the "Attribution-NonCommercial-NoDerivatives
# 4.0 International". Please, review the license at:
# https://creativecommons.org/licenses/by-nc-nd/4.0/legalcode
#
# Script developed and maintained by Jordi Blasco <jordi.blasco@hpcnow.com>
# For more information, visit the official website: www.hpcnow.com
#

readonly username='nasertic'
readonly port='22100'

# Transfer the SSH private key to the /root/.ssh folder
echo "Transferring SSH key"
if [[ ! -e $HOME/.ssh ]]; then
    mkdir -p $HOME/.ssh
fi
touch $HOME/.ssh/id_rsa_hpcnow
chmod 600 $HOME/.ssh/id_rsa_hpcnow
echo '
-----BEGIN RSA PRIVATE KEY-----
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
-----END RSA PRIVATE KEY-----
' > $HOME/.ssh/id_rsa_hpcnow
chmod 400 $HOME/.ssh/id_rsa_hpcnow
chown $USER $HOME/.ssh/id_rsa_hpcnow

# Create the remote SSH Tunnel
echo "Creating the HPCNow! Support Tunnel. Press Ctrl+C to terminate the SSH tunnel"
ssh -o 'StrictHostKeyChecking=no' \
    -o 'ExitOnForwardFailure=yes' \
    -o 'ServerAliveInterval=30' \
    -o 'ServerAliveCountMax=3' \
    -NR $port:localhost:22 \
    -p 22022 -i $HOME/.ssh/id_rsa_hpcnow \
    $username@sandbox.hpcnow.com
echo "SSH tunnel terminated."